# 🔧 Schema Drift Management Guide

> **TJ님 진단에 따른 근본 원인 해결 문서**  
> 스키마 드리프트 문제의 체계적 관리 방안

## 📋 문제 원인 및 해결책

### 🔍 **진단 결과**

| 구분 | 원인 | 해결책 |
|------|------|--------|
| **1. 베이스라인 지연** | 실제 DB가 베이스라인보다 앞서 있음 | 표준화된 재생성 절차 구축 |
| **2. 예외 규칙 부재** | 임시/백업 테이블을 동일하게 검사 | 패턴 기반 예외 규칙 적용 |
| **3. 파이프라인 순서** | 마이그레이션 → 배포 → 베이스라인 순서 혼재 | CI/CD 종속성 명시 |

---

## 🛠️ 해결책 구현

### 1️⃣ **스키마 예외 규칙 시스템**

#### 자동 제외 패턴
```yaml
# ci/schema_drift_config.yml
ignore_tables:
  - "^staging_.*"                    # 스테이징 테이블
  - ".*_backup$"                     # 백업 테이블
  - "^payment_staff_changes$"        # 변경 로그 테이블
  - "^.*_additional_backup$"         # 추가 백업
  - "^temp_.*"                       # 임시 테이블
  - "^archive_.*"                    # 아카이브 테이블
```

#### 적용 효과
- ✅ **False Positive 제거**: 불필요한 드리프트 경고 차단
- ✅ **핵심 테이블 집중**: 비즈니스 크리티컬 테이블만 모니터링
- ✅ **운영 편의성**: 백업/로그 테이블 자유롭게 관리

### 2️⃣ **표준화된 베이스라인 관리**

#### 재생성 절차
```bash
# 1. 전체 절차 자동화
python scripts/standardized_baseline_refresh.py

# 2. 단계별 수동 실행
python scripts/check_schema_against_baseline.py  # 현재 상태 확인
python scripts/update_schema_baseline.py         # 베이스라인 업데이트
git add ci/schema_baseline.json && git commit    # 변경사항 저장
```

#### 검증 체계
- 🔄 **마이그레이션 우선**: 모든 DB 변경 적용 후 베이스라인 업데이트
- 🔍 **자동 검증**: 업데이트 후 즉시 드리프트 재검사
- 📦 **안전 백업**: 기존 베이스라인 자동 백업

### 3️⃣ **CI/CD 파이프라인 개선**

#### 종속성 기반 실행 순서
```yaml
jobs:
  migrate:           # 1단계: 마이그레이션 실행
    steps: [alembic upgrade head]
    
  schema-drift-check: # 2단계: 스키마 검사 (마이그레이션 완료 후)
    needs: migrate
    steps: [check with exclusion rules]
    
  build:             # 3단계: 애플리케이션 빌드
    needs: schema-drift-check
```

#### 개선 효과
- ✅ **순서 보장**: 마이그레이션 → 드리프트 검사 → 빌드 순서 강제
- ✅ **빠른 실패**: 스키마 문제 조기 발견
- ✅ **명확한 피드백**: 단계별 실패 원인 명시

---

## 📊 운영 모니터링

### **비즈니스 크리티컬 테이블**
```yaml
critical_tables:
  - customers       # 고객 정보
  - payments        # 결제 데이터  
  - reservations    # 예약 정보
  - services        # 서비스 관리
  - service_types   # 서비스 유형
  - packages        # 패키지 관리
  - users          # 사용자 계정
```

### **모니터링 대시보드**
- 📈 **드리프트 발생 빈도**: 주간/월간 통계
- 🎯 **테이블별 변경 이력**: 핵심 테이블 변경 추적
- ⚡ **해결 시간**: 드리프트 감지 → 해결 완료 시간
- 📧 **알림 현황**: 팀 알림 발송 및 응답 상태

---

## 🔄 정기 운영 절차

### **일일 점검**
- [ ] Schema Drift Detection 실행 결과 확인
- [ ] 실패한 CI/CD 파이프라인 원인 분석
- [ ] 긴급 스키마 변경 승인 여부 검토

### **주간 리뷰**
- [ ] 제외된 테이블 패턴 검토 (새로운 백업 테이블 등)
- [ ] 베이스라인 업데이트 이력 분석
- [ ] False Positive/Negative 발생 케이스 개선

### **월간 정비**
- [ ] 예외 규칙 최적화
- [ ] 크리티컬 테이블 목록 갱신
- [ ] 스키마 변경 승인 프로세스 개선
- [ ] 팀 교육 및 가이드라인 업데이트

---

## 🚨 비상 대응 절차

### **드리프트 감지 시**
1. **즉시 조치** (5분 이내)
   - 드리프트 리포트 확인
   - 비즈니스 크리티컬 테이블 영향도 파악
   
2. **원인 분석** (15분 이내)
   - 최근 마이그레이션 이력 검토
   - 수동 DB 변경 여부 확인
   - 백업/임시 테이블 여부 판단
   
3. **해결 조치** (30분 이내)
   - 예외 테이블: 패턴 추가 후 베이스라인 재생성
   - 정상 변경: 표준 절차로 베이스라인 업데이트
   - 문제 상황: DBA 팀 에스컬레이션

### **긴급 승인 프로세스**
```bash
# 임시 드리프트 무시 (긴급시에만 사용)
echo "EMERGENCY_BYPASS=true" >> $GITHUB_ENV

# 사후 정리 (24시간 이내 필수)
python scripts/standardized_baseline_refresh.py
git commit -m "fix: emergency schema drift resolution"
```

---

## 📈 성과 측정 지표

### **정량 지표**
- 🎯 **드리프트 해결 시간**: 평균 30분 이내 목표
- 📉 **False Positive 비율**: 월 5% 이하 유지
- ✅ **자동화 성공률**: 베이스라인 재생성 95% 이상
- 🔄 **정기 점검 준수율**: 주간 리뷰 100% 실시

### **정성 지표**
- 👥 **팀 만족도**: 개발자 피드백 수집
- 🛡️ **시스템 안정성**: 프로덕션 장애 감소
- 📚 **지식 공유**: 문서화 및 교육 효과성
- 🔧 **프로세스 개선**: 지속적 최적화 실행

---

## 🤔 FAQ

### Q1. 임시 테이블을 완전히 분리하면 애플리케이션 영향은?
**A**: 현재 애플리케이션은 주로 `public` 스키마의 핵심 테이블만 사용하므로 영향 최소. 백업/임시 테이블을 `archive` 스키마로 분리시 쿼리 수정 없이 테이블명만 변경.

### Q2. 예외 패턴 적용 후 필요 테이블 누락 위험은?
**A**: 
- **모니터링**: 월간 패턴 검토로 누락 방지
- **화이트리스트**: 크리티컬 테이블은 명시적 포함
- **알림**: 새 테이블 생성시 DBA 검토 알림

### Q3. Alembic 대신 명시적 스크립트 작성의 장점은?
**A**:
- **리뷰 품질**: 모든 스키마 변경이 명시적 PR로 검토
- **롤백 안정성**: 수동 작성된 마이그레이션이 더 예측 가능
- **문서화**: 변경 이유와 영향도가 코드에 명시

---

## 🔗 관련 문서
- [데이터베이스 스키마](./database-schema.md)
- [개발 규칙](./development-rules.md) 
- [배포 체크리스트](./deployment-checklist.md)

---

*이 문서는 TJ님의 정확한 문제 진단을 바탕으로 작성되었습니다.*  
*지속적인 개선을 통해 최적의 스키마 관리 체계를 구축해 나가겠습니다.* 🚀