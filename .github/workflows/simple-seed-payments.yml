name: ðŸš€ Simple Seed Payments

on:
  workflow_dispatch:

jobs:
  seed:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          
      - name: Install Dependencies
        run: pip install psycopg2-binary
          
      - name: Seed Payments
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          python - << 'EOF'
          import csv
          import psycopg2
          import os
          
          # ê°„ë‹¨í•œ ë³€í™˜ í•¨ìˆ˜
          def convert_method(m):
              return {"ì¹´ë“œ": "card", "ì´ì²´": "transfer", "í˜„ê¸ˆ": "cash"}.get(m, "card")
          
          # DB ì—°ê²°
          conn = psycopg2.connect(os.environ['DATABASE_URL'])
          cursor = conn.cursor()
          
          # í˜„ìž¬ ìƒíƒœ í™•ì¸
          cursor.execute("SELECT COUNT(*) FROM payments")
          before = cursor.fetchone()[0]
          print(f"í˜„ìž¬: {before}ê±´")
          
          # CSV ì½ê³  ì‚½ìž…
          with open('backend/seed/payments_real.csv', 'r', encoding='utf-8') as f:
              reader = csv.DictReader(f)
              count = 0
              
              for row in reader:
                  try:
                      cursor.execute("""
                          INSERT INTO payments (customer_id, payment_date, amount, payment_method, created_at)
                          VALUES (%s, %s, %s, %s, %s)
                          ON CONFLICT DO NOTHING
                      """, (
                          int(row['customer_id']),
                          row['payment_date'],
                          float(row['amount']),
                          convert_method(row['payment_method']),
                          row['created_at']
                      ))
                      count += 1
                      if count % 50 == 0:
                          conn.commit()
                          print(f"ì§„í–‰: {count}ê±´")
                  except Exception as e:
                      print(f"ì˜¤ë¥˜: {e}")
                      continue
              
              conn.commit()
              
              # ìµœì¢… í™•ì¸
              cursor.execute("SELECT COUNT(*) FROM payments")
              after = cursor.fetchone()[0]
              print(f"ì™„ë£Œ! ì´ì „: {before}ê±´ â†’ ì´í›„: {after}ê±´ (ì¶”ê°€: {after-before}ê±´)")
              
              cursor.close()
              conn.close()
          EOF