name: Schema Drift Detection

on:
  push:
    branches: [main]
  pull_request:
    paths:
      - 'backend/models/**'
      - 'backend/alembic/**'
      - 'supabase/migrations/**'

jobs:
  schema-diff:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install Dependencies
        run: |
          pip install psycopg2-binary
      
      - name: Check Schema Drift
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_URL: ${{ secrets.DATABASE_URL }}
        run: |
          # ìŠ¤í‚¤ë§ˆ ì°¨ì´ ê°ì§€
          echo "ğŸ” Checking for schema drift..."
          
          # Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          python scripts/check_db_schema_diff.py > schema_diff.sql
          
          # ì°¨ì´ê°€ ìˆìœ¼ë©´ ìë™ ìˆ˜ì •
          if [ -s schema_diff.sql ]; then
            echo "âš ï¸ Schema drift detected!"
            echo "ğŸ“ Generated fix SQL:"
            cat schema_diff.sql
            
            # PR ì½”ë©˜íŠ¸ë¡œ ì•Œë¦¼
            if [ "${{ github.event_name }}" == "pull_request" ]; then
              gh pr comment ${{ github.event.pull_request.number }} --body "## ğŸš¨ Schema Drift Detected
              
              The following SQL needs to be executed in Supabase:
              
              \`\`\`sql
              $(cat schema_diff.sql)
              \`\`\`
              
              Please run this in Supabase SQL Editor before merging."
            fi
            
            # ì‹¤íŒ¨ë¡œ í‘œì‹œí•˜ì—¬ ë¨¸ì§€ ë°©ì§€
            exit 1
          else
            echo "âœ… No schema drift detected"
          fi
      
      - name: Auto-fix Schema (Production)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        env:
          SUPABASE_DB_URL: ${{ secrets.DATABASE_URL }}
        run: |
          # ë©”ì¸ ë¸Œëœì¹˜ì— í‘¸ì‹œëœ ê²½ìš° ìë™ ìˆ˜ì • ì‹œë„
          if [ -s schema_diff.sql ]; then
            echo "ğŸ”§ Attempting automatic fix..."
            
            # ì•ˆì „í•œ ë³€ê²½ì‚¬í•­ë§Œ ìë™ ì ìš© (ADD COLUMNë§Œ)
            if grep -q "ALTER TABLE.*ADD COLUMN" schema_diff.sql && ! grep -q "DROP\|DELETE\|TRUNCATE" schema_diff.sql; then
              echo "âœ… Safe changes detected, applying..."
              # ì—¬ê¸°ì„œ ì‹¤ì œ ì ìš©í•˜ë ¤ë©´ Supabase API ì‚¬ìš©
              # supabase db push ë˜ëŠ” ì§ì ‘ SQL ì‹¤í–‰
            else
              echo "âš ï¸ Unsafe changes detected, manual intervention required"
              
              # Slack/Discord ì•Œë¦¼ (webhook URL í•„ìš”)
              # curl -X POST ${{ secrets.SLACK_WEBHOOK }} -d '{"text":"Schema drift requires manual fix"}'
            fi
          fi