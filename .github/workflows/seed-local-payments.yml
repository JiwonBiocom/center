name: ğŸš€ Seed Local Payments Data

on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰

jobs:
  seed-payments:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          
      - name: ğŸ“¦ Install Dependencies
        run: |
          pip install psycopg2-binary python-dotenv
          
      - name: ğŸ” Check CSV File
        run: |
          echo "ğŸ“Š ë¡œì»¬ ê²°ì œ ë°ì´í„° í™•ì¸:"
          echo "íŒŒì¼ í¬ê¸°: $(du -h backend/seed/payments_real.csv)"
          echo "ë°ì´í„° ìˆ˜: $(wc -l backend/seed/payments_real.csv)"
          echo ""
          echo "ìƒ˜í”Œ ë°ì´í„° (ì²˜ìŒ 5ì¤„):"
          head -5 backend/seed/payments_real.csv
          
      - name: ğŸš€ Upload Payments to Supabase
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          python - << 'EOF'
          import csv
          import psycopg2
          import os
          from datetime import datetime
          
          def convert_payment_method(method):
              method_map = {
                  "ì¹´ë“œ": "card",
                  "ì´ì²´": "transfer",
                  "í˜„ê¸ˆ": "cash"
              }
              return method_map.get(method, method.lower())
          
          # ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°
          database_url = os.environ.get('DATABASE_URL')
          if not database_url:
              print("âŒ DATABASE_URL not found")
              exit(1)
          
          print(f"ğŸ”— ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì¤‘...")
          print(f"   URL: {database_url[:30]}...")  # URL ì¼ë¶€ë§Œ í‘œì‹œ
          
          conn = psycopg2.connect(database_url)
          cursor = conn.cursor()
          
          # í˜„ì¬ ë°ì´í„° í™•ì¸
          cursor.execute("SELECT COUNT(*) FROM payments")
          before_count = cursor.fetchone()[0]
          print(f"ğŸ“Š í˜„ì¬ ê²°ì œ ë°ì´í„°: {before_count}ê±´")
          
          # payment_type ì»¬ëŸ¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
          cursor.execute("""
              SELECT column_name 
              FROM information_schema.columns 
              WHERE table_name = 'payments' AND column_name = 'payment_type'
          """)
          has_payment_type = cursor.fetchone() is not None
          
          # CSV ë°ì´í„° ì½ê¸°
          with open('backend/seed/payments_real.csv', 'r', encoding='utf-8') as f:
              reader = csv.DictReader(f)
              
              success_count = 0
              skip_count = 0
              
              for row in reader:
                  try:
                      # ì¤‘ë³µ í™•ì¸
                      cursor.execute("""
                          SELECT payment_id FROM payments 
                          WHERE customer_id = %s AND payment_date = %s AND amount = %s
                      """, (row['customer_id'], row['payment_date'], row['amount']))
                      
                      if cursor.fetchone():
                          skip_count += 1
                          continue
                      
                      # ë°ì´í„° ì‚½ì…
                      if has_payment_type:
                          cursor.execute("""
                              INSERT INTO payments (customer_id, payment_date, amount, payment_method, payment_type, payment_status, created_at)
                              VALUES (%s, %s, %s, %s, %s, %s, %s)
                          """, (
                              int(row['customer_id']),
                              row['payment_date'],
                              float(row['amount']),
                              convert_payment_method(row['payment_method']),
                              'regular',  # ë˜ëŠ” ë‹¤ë¥¸ ìœ íš¨í•œ enum ê°’
                              'completed',
                              row['created_at'] or datetime.now().isoformat()
                          ))
                      else:
                          cursor.execute("""
                              INSERT INTO payments (customer_id, payment_date, amount, payment_method, created_at)
                              VALUES (%s, %s, %s, %s, %s)
                          """, (
                              int(row['customer_id']),
                              row['payment_date'],
                              float(row['amount']),
                              convert_payment_method(row['payment_method']),
                              row['created_at'] or datetime.now().isoformat()
                          ))
                      
                      success_count += 1
                      
                      if success_count % 50 == 0:
                          print(f"  ì§„í–‰ì¤‘... {success_count}ê±´ ì¶”ê°€")
                          conn.commit()
                          
                  except Exception as e:
                      print(f"  âš ï¸ ì˜¤ë¥˜: {e}")
                      continue
              
              # ìµœì¢… ì»¤ë°‹
              conn.commit()
              
              print(f"\nâœ… ì—…ë¡œë“œ ì™„ë£Œ!")
              print(f"  - ì¶”ê°€: {success_count}ê±´")
              print(f"  - ì¤‘ë³µ ìŠ¤í‚µ: {skip_count}ê±´")
              
              # ìµœì¢… í†µê³„
              cursor.execute("SELECT COUNT(*) FROM payments")
              after_count = cursor.fetchone()[0]
              print(f"\nğŸ“ˆ ìµœì¢… ê²°ì œ ë°ì´í„°: {after_count}ê±´ (ì¦ê°€: {after_count - before_count}ê±´)")
              
          cursor.close()
          conn.close()
          EOF
          
      - name: ğŸ‰ Success Notification
        if: success()
        run: |
          echo "ğŸ‰ ë¡œì»¬ ê²°ì œ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ!"
          echo "ğŸ’¡ í™•ì¸:"
          echo "   - https://center-ten.vercel.app/payments"