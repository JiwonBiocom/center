name: Nightly Seed Validation

on:
  schedule:
    # ë§¤ì¼ ìƒˆë²½ 2ì‹œ (KST ê¸°ì¤€)
    - cron: '0 17 * * *'  # UTC 17:00 = KST 02:00
  
  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥
  workflow_dispatch:

jobs:
  validate-seed-data:
    name: Validate Production Data
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install psycopg2-binary
      
      - name: Check critical tables
        id: check-data
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          cat > check_tables.py <<'EOF'
          import psycopg2
          from urllib.parse import urlparse
          import os
          import json
          
          url = urlparse(os.environ['DATABASE_URL'])
          conn = psycopg2.connect(
              host=url.hostname,
              port=url.port,
              database=url.path[1:],
              user=url.username,
              password=url.password,
              sslmode='require'
          )
          cur = conn.cursor()
          
          # ê²€ì¦í•  í…Œì´ë¸”ê³¼ ìµœì†Œ ë ˆì½”ë“œ ìˆ˜
          critical_tables = {
              'customers': 100,        # ìµœì†Œ 100ëª… ì´ìƒ
              'payments': 50,          # ìµœì†Œ 50ê±´ ì´ìƒ
              'packages': 5,           # ìµœì†Œ 5ê°œ ì´ìƒ
              'marketing_leads': 10,   # ìµœì†Œ 10ê±´ ì´ìƒ
              'kit_receipts': 5,       # ìµœì†Œ 5ê±´ ì´ìƒ
              'service_types': 5       # ìµœì†Œ 5ê°œ ì´ìƒ
          }
          
          results = {}
          has_issues = False
          
          for table, min_count in critical_tables.items():
              try:
                  cur.execute(f'SELECT COUNT(*) FROM {table}')
                  count = cur.fetchone()[0]
                  
                  if count < min_count:
                      results[table] = {
                          'status': 'WARNING',
                          'count': count,
                          'min_required': min_count,
                          'message': f'{table} has only {count} records (minimum: {min_count})'
                      }
                      has_issues = True
                  else:
                      results[table] = {
                          'status': 'OK',
                          'count': count,
                          'min_required': min_count
                      }
              except Exception as e:
                  results[table] = {
                      'status': 'ERROR',
                      'message': str(e)
                  }
                  has_issues = True
          
          # ê²°ê³¼ ì¶œë ¥
          print('ğŸ“Š í”„ë¡œë•ì…˜ ë°ì´í„° ê²€ì¦ ê²°ê³¼:')
          print('=' * 60)
          
          for table, result in results.items():
              status_icon = 'âœ…' if result['status'] == 'OK' else 'âš ï¸' if result['status'] == 'WARNING' else 'âŒ'
              print(f"{status_icon} {table}: {result.get('count', 'N/A')} ë ˆì½”ë“œ")
              if result['status'] != 'OK':
                  print(f"   â†’ {result.get('message', '')}")
          
          # GitHub Actions ì¶œë ¥ ë³€ìˆ˜ ì„¤ì •
          print(f'::set-output name=has_issues::{str(has_issues).lower()}')
          print(f'::set-output name=results::{json.dumps(results)}')
          
          cur.close()
          conn.close()
          
          # ë¬¸ì œê°€ ìˆìœ¼ë©´ exit code 1 ë°˜í™˜
          if has_issues:
              exit(1)
          EOF
          
          python check_tables.py
      
      - name: Create issue if validation fails
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const title = `ğŸš¨ í”„ë¡œë•ì…˜ ë°ì´í„° ê²€ì¦ ì‹¤íŒ¨ - ${date}`;
            
            // ê¸°ì¡´ ì´ìŠˆê°€ ìˆëŠ”ì§€ í™•ì¸
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'data-validation'
            });
            
            const existingIssue = issues.data.find(issue => 
              issue.title.includes('í”„ë¡œë•ì…˜ ë°ì´í„° ê²€ì¦ ì‹¤íŒ¨')
            );
            
            const body = `## í”„ë¡œë•ì…˜ ë°ì´í„° ê²€ì¦ ì‹¤íŒ¨
            
            ë§¤ì¼ ìƒˆë²½ ì‹¤í–‰ë˜ëŠ” ë°ì´í„° ê²€ì¦ì—ì„œ ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.
            
            ### ê²€ì¦ ì‹œê°„
            - ${new Date().toLocaleString('ko-KR', {timeZone: 'Asia/Seoul'})} (KST)
            
            ### ë¬¸ì œ ë‚´ìš©
            ì¼ë¶€ í…Œì´ë¸”ì˜ ë°ì´í„°ê°€ ìµœì†Œ ìš”êµ¬ì‚¬í•­ì„ ì¶©ì¡±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.
            
            ### ì¡°ì¹˜ í•„ìš”
            1. [Actions ë¡œê·¸](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) í™•ì¸
            2. ëˆ„ë½ëœ ë°ì´í„° í™•ì¸
            3. í•„ìš”ì‹œ ìˆ˜ë™ ì‹œë“œ ì‹¤í–‰
            
            ### ìˆ˜ë™ ì‹œë“œ ì‹¤í–‰ ë°©ë²•
            1. [Actions íƒ­](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/workflows/seed-production-db.yml) ì ‘ì†
            2. "Run workflow" í´ë¦­
            3. ëŒ€ìƒ í…Œì´ë¸” ì„ íƒ í›„ ì‹¤í–‰
            
            cc: @${context.actor}`;
            
            if (existingIssue) {
              // ê¸°ì¡´ ì´ìŠˆì— ì½”ë©˜íŠ¸ ì¶”ê°€
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: body
              });
            } else {
              // ìƒˆ ì´ìŠˆ ìƒì„±
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['data-validation', 'production', 'urgent']
              });
            }
      
      - name: Notify success
        if: success()
        run: |
          echo "âœ… ëª¨ë“  í”„ë¡œë•ì…˜ ë°ì´í„°ê°€ ì •ìƒì…ë‹ˆë‹¤!"
          echo "ğŸ“Š ê²€ì¦ ì™„ë£Œ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S KST')"