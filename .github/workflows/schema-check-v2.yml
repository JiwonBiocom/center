name: Schema Drift Detection v2

on:
  push:
    branches: [main]
  pull_request:
    paths:
      - 'backend/models/**'
      - 'backend/alembic/**'
      - 'supabase/migrations/**'
      - 'ci/schema_baseline.json'

jobs:
  # ğŸ”§ TJë‹˜ ì œì•ˆ: ë§ˆì´ê·¸ë ˆì´ì…˜ ìˆœì„œ ì •ë¹„
  migrate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install Dependencies
        run: |
          pip install psycopg2-binary
          cd backend && pip install -r requirements.txt

      - name: Run Database Migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "ğŸ”„ Running database migrations..."
          # ğŸ”§ TJë‹˜ ì œì•ˆ: ë£¨íŠ¸ì—ì„œ ì ˆëŒ€ ê²½ë¡œë¡œ ì‹¤í–‰
          alembic -c alembic.ini upgrade head
          echo "âœ… Migrations completed"

  # ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ í›„ì—ë§Œ ì‹¤í–‰
  schema-drift-check:
    runs-on: ubuntu-latest
    needs: migrate  # ğŸ”§ ì¢…ì†ì„± ì§€ì •
    steps:
      - uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install Dependencies
        run: |
          pip install psycopg2-binary pyyaml
          cd backend && pip install -r requirements.txt

      - name: Check Enum Consistency
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "ğŸ” Checking Enum consistency..."
          python scripts/check_enum_values.py || {
            echo "::error::Enum values mismatch detected!"
            exit 1
          }

      - name: Schema Drift Detection with Exclusion Rules
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "ğŸ” Checking schema against baseline (with exclusion rules)..."

          # ğŸ”§ ê°œì„ ëœ ìŠ¤í¬ë¦½íŠ¸ë¡œ baselineê³¼ í˜„ì¬ DB ë¹„êµ
          python scripts/check_schema_against_baseline.py

          # ì°¨ì´ê°€ ìˆìœ¼ë©´ ìë™ PR ìƒì„±ì„ ìœ„í•œ ë§ˆí¬
          if [ -f schema_drift_detected.flag ]; then
            echo "DRIFT_DETECTED=true" >> $GITHUB_ENV
          fi

      - name: Schema Drift Notification
        if: env.DRIFT_DETECTED == 'true'
        run: |
          echo "ğŸš¨ Schema Drift Detected!"
          echo "::error::Core business table schema has changed from baseline."
          echo "::notice::â­ï¸ Backup/staging tables are automatically excluded from drift detection."
          echo "::notice::ğŸ“‹ Run 'python scripts/standardized_baseline_refresh.py' to update baseline safely."
          echo "::notice::ğŸ“§ Or create an issue for manual review by DBA team."

          # ìŠ¤í‚¤ë§ˆ ì°¨ì´ ë³´ê³ ì„œ ì¶œë ¥
          if [ -f schema_drift_report.md ]; then
            echo "ğŸ“‹ Schema Drift Report:"
            cat schema_drift_report.md
          fi

          # ì‹¤íŒ¨ë¡œ ë§ˆí‚¹í•˜ì—¬ ìˆ˜ë™ ê°œì… ìœ ë„
          exit 1
