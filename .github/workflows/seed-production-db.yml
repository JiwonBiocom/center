name: Seed Production Database

on:
  # ìˆ˜ë™ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      target:
        description: 'ì‹œë“œí•  í…Œì´ë¸” ì„ íƒ'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - marketing_leads
          - kit_receipts
  
  # ì‹œë“œ íŒŒì¼ ë³€ê²½ ì‹œ ìë™ ì‹¤í–‰
  push:
    branches: [main]
    paths:
      - 'backend/seed/**'
      - 'scripts/import_*.py'

jobs:
  seed-database:
    name: Seed Production Database
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true  # Git LFS íŒŒì¼ ë‹¤ìš´ë¡œë“œ
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install pandas psycopg2-binary openpyxl
      
      - name: Check seed files
        run: |
          echo "ğŸ“ ì‹œë“œ íŒŒì¼ í™•ì¸:"
          ls -la backend/seed/
      
      - name: Seed marketing_leads
        if: github.event.inputs.target == 'all' || github.event.inputs.target == 'marketing_leads'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "ğŸŒ± ìœ ì…ê³ ê° ë°ì´í„° ì‹œë“œ ì¤‘..."
          python scripts/import_marketing_leads.py
      
      - name: Seed kit_receipts
        if: github.event.inputs.target == 'all' || github.event.inputs.target == 'kit_receipts'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "ğŸŒ± ê²€ì‚¬í‚¤íŠ¸ ìˆ˜ë ¹ ë°ì´í„° ì‹œë“œ ì¤‘..."
          python scripts/import_kit_receipts.py
      
      - name: Verify seeding
        if: always()
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "ğŸ“Š ì‹œë“œ ê²°ê³¼ í™•ì¸:"
          python -c "
          import psycopg2
          from urllib.parse import urlparse
          import os
          
          url = urlparse(os.environ['DATABASE_URL'])
          conn = psycopg2.connect(
              host=url.hostname,
              port=url.port,
              database=url.path[1:],
              user=url.username,
              password=url.password,
              sslmode='require'
          )
          cur = conn.cursor()
          
          tables = ['marketing_leads', 'kit_management']
          for table in tables:
              try:
                  cur.execute(f'SELECT COUNT(*) FROM {table}')
                  count = cur.fetchone()[0]
                  print(f'  - {table}: {count:,} ë ˆì½”ë“œ')
              except Exception as e:
                  print(f'  - {table}: í™•ì¸ ë¶ˆê°€ ({e})')
          
          cur.close()
          conn.close()
          "
      
      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ í”„ë¡œë•ì…˜ DB ì‹œë“œ ì‹¤íŒ¨! ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.'
            })