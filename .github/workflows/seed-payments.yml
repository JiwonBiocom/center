name: ğŸš€ Seed Payments to Supabase Prod

on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰
    inputs:
      force_seed:
        description: 'ê°•ì œë¡œ ì‹œë“œ ì‹¤í–‰ (ê¸°ì¡´ ë°ì´í„° ë¬´ì‹œ)'
        required: false
        default: 'false'
        type: boolean
  schedule:
    - cron: '0 21 * * 0'   # ë§¤ì£¼ ì¼ìš”ì¼ 06:00 KST (21:00 UTC)

jobs:
  seed-payments:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest
          
      - name: ğŸ“Š Check Current Payment Count
        id: check-payments
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          # í˜„ì¬ payments í…Œì´ë¸” ë ˆì½”ë“œ ìˆ˜ í™•ì¸
          count=$(supabase db remote exec -c "SELECT COUNT(*) FROM payments;" | tail -1 | tr -d ' ')
          echo "í˜„ì¬ payments ë ˆì½”ë“œ ìˆ˜: $count"
          echo "payment_count=$count" >> $GITHUB_OUTPUT
          
      - name: ğŸš€ Load Payments Data
        if: ${{ steps.check-payments.outputs.payment_count == '0' || github.event.inputs.force_seed == 'true' }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          echo "ğŸ“ ê²°ì œ ë°ì´í„° ë¡œë”© ì‹œì‘..."
          cat backend/seed/payments.csv | supabase db remote exec -f sql/load_payments.sql
          echo "âœ… ê²°ì œ ë°ì´í„° ë¡œë”© ì™„ë£Œ"
          
      - name: ğŸ§ª API Smoke Test
        run: |
          echo "ğŸ” API í…ŒìŠ¤íŠ¸ ì‹œì‘..."
          
          # Railway API í…ŒìŠ¤íŠ¸
          API_URL="https://center-production-1421.up.railway.app"
          
          # Payments API í…ŒìŠ¤íŠ¸
          response=$(curl -s -w "%{http_code}" "$API_URL/api/v1/payments/?limit=5" -o /tmp/payments_response.json)
          
          if [ "$response" = "200" ]; then
            echo "âœ… Payments API ì •ìƒ ì‘ë‹µ (HTTP 200)"
            
            # ì‘ë‹µ ë°ì´í„° ê°œìˆ˜ í™•ì¸
            count=$(jq '. | length' /tmp/payments_response.json)
            echo "ğŸ“Š API ì‘ë‹µ ë°ì´í„° ê°œìˆ˜: $count"
            
            if [ "$count" -gt "0" ]; then
              echo "âœ… ê²°ì œ ë°ì´í„°ê°€ ì •ìƒì ìœ¼ë¡œ ë°˜í™˜ë¨"
              echo "ğŸ“‹ ìƒ˜í”Œ ë°ì´í„°:"
              jq -r '.[:3] | .[] | "  - ID:\(.payment_id) | \(.payment_date) | â‚©\(.amount) | \(.payment_method)"' /tmp/payments_response.json
            else
              echo "âš ï¸ APIëŠ” ì •ìƒì´ì§€ë§Œ ë°ì´í„°ê°€ ì—†ìŒ"
              exit 1
            fi
          else
            echo "âŒ API ì—ëŸ¬: HTTP $response"
            cat /tmp/payments_response.json
            exit 1
          fi
          
      - name: ğŸ“Š Final Statistics
        if: success()
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          echo "ğŸ“ˆ ìµœì¢… í†µê³„:"
          supabase db remote exec -c "
            SELECT 
              COUNT(*) as total_payments,
              COUNT(DISTINCT customer_id) as customers_with_payments,
              SUM(amount) as total_revenue,
              MIN(payment_date) as earliest_payment,
              MAX(payment_date) as latest_payment
            FROM payments;
          "
          
      - name: ğŸ‰ Success Notification
        if: success()
        run: |
          echo "ğŸ‰ ê²°ì œ ë°ì´í„° ì‹œë”© ì™„ë£Œ!"
          echo "ğŸ’¡ ë‹¤ìŒì—ì„œ í™•ì¸ ê°€ëŠ¥:"
          echo "   - API: https://center-production-1421.up.railway.app/api/v1/payments/"
          echo "   - UI: https://center-ten.vercel.app/payments"
          
      - name: âŒ Failure Notification
        if: failure()
        run: |
          echo "âŒ ê²°ì œ ë°ì´í„° ì‹œë”© ì‹¤íŒ¨!"
          echo "ğŸ” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ ì§„ë‹¨í•˜ì„¸ìš”."