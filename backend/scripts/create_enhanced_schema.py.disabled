"""
Enhanced Database Schema Creation Script
ìƒˆë¡œìš´ PRD ìš”êµ¬ì‚¬í•­ì— ë§ëŠ” í™•ì¥ëœ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ìƒì„±
"""

import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from sqlalchemy import create_engine, text
from core.database import Base, engine, get_db
from models.enhanced_service import (
    EnhancedServiceType,
    ServiceSession,
    EnhancedPackageUsage,
    CustomerServicePreference,
    EquipmentManagement
)

def create_enhanced_tables():
    """í™•ì¥ëœ í…Œì´ë¸”ë“¤ ìƒì„±"""
    print("=== Enhanced Service Management Schema Creation ===")
    print(f"Database URL: {engine.url}")
    
    try:
        # í…Œì´ë¸” ìƒì„±
        print("\n1. Creating enhanced tables...")
        Base.metadata.create_all(bind=engine, tables=[
            EnhancedServiceType.__table__,
            ServiceSession.__table__,
            EnhancedPackageUsage.__table__,
            CustomerServicePreference.__table__,
            EquipmentManagement.__table__
        ])
        print("âœ… Enhanced tables created successfully")
        
        # ê¸°ë³¸ ì„œë¹„ìŠ¤ íƒ€ì… ë°ì´í„° ìƒì„±
        print("\n2. Creating default service types...")
        create_default_service_types()
        
        # ê¸°ë³¸ ì¥ë¹„ ë°ì´í„° ìƒì„±
        print("\n3. Creating default equipment...")
        create_default_equipment()
        
        print("\nğŸ‰ Enhanced schema creation completed successfully!")
        
    except Exception as e:
        print(f"âŒ Error creating enhanced schema: {e}")
        raise

def create_default_service_types():
    """ê¸°ë³¸ ì„œë¹„ìŠ¤ íƒ€ì… ë°ì´í„° ìƒì„±"""
    db = next(get_db())
    try:
        service_types = [
            {
                "name": "ë¸Œë ˆì¸",
                "code": "BRAIN",
                "description": "ë‡Œ ìµœì í™” í”„ë¡œê·¸ë¨ - ì¸ì§€ëŠ¥ë ¥ í–¥ìƒ ë° ë‡Œ ê±´ê°• ê°œì„ ",
                "default_duration": 40,
                "default_price": 80000,
                "equipment_required": {
                    "brain_device": {
                        "type": "neurofeedback",
                        "model": "Brain Optimizer Pro",
                        "channels": 8
                    }
                },
                "protocols": {
                    "basic": {"frequency": "8-12Hz", "duration": 40},
                    "intensive": {"frequency": "10-15Hz", "duration": 50},
                    "relaxation": {"frequency": "6-10Hz", "duration": 35}
                },
                "intensity_levels": {
                    "weak": {"power": 30, "description": "ì•½í•œ ê°•ë„"},
                    "medium": {"power": 60, "description": "ì¤‘ê°„ ê°•ë„"},
                    "strong": {"power": 90, "description": "ê°•í•œ ê°•ë„"}
                },
                "sort_order": 1
            },
            {
                "name": "í„ìŠ¤",
                "code": "PULSE",
                "description": "ìˆœí™˜ ê°œì„  í”„ë¡œê·¸ë¨ - í˜ˆì•¡ìˆœí™˜ ì´‰ì§„ ë° í˜ˆê´€ ê±´ê°• ê°œì„  (ê°€ì¥ ì¸ê¸° ì„œë¹„ìŠ¤)",
                "default_duration": 30,
                "default_price": 60000,
                "equipment_required": {
                    "pulse_device": {
                        "type": "electromagnetic",
                        "model": "Pulse Wave Generator",
                        "frequency_range": "1-100Hz"
                    }
                },
                "protocols": {
                    "circulation": {"frequency": "10Hz", "duration": 30},
                    "recovery": {"frequency": "20Hz", "duration": 25},
                    "maintenance": {"frequency": "5Hz", "duration": 35}
                },
                "intensity_levels": {
                    "weak": {"power": 25, "description": "ì•½í•œ ê°•ë„"},
                    "medium": {"power": 50, "description": "ì¤‘ê°„ ê°•ë„"},
                    "strong": {"power": 75, "description": "ê°•í•œ ê°•ë„"}
                },
                "sort_order": 2
            },
            {
                "name": "ë¦¼í”„",
                "code": "LYMPH",
                "description": "ë¦¼í”„ ìˆœí™˜ ê°œì„  - ë…ì†Œ ë°°ì¶œ ë° ë©´ì—­ë ¥ ê°•í™”",
                "default_duration": 35,
                "default_price": 70000,
                "equipment_required": {
                    "lymph_device": {
                        "type": "pressure_wave",
                        "model": "Lymphatic Drainage System",
                        "pressure_range": "10-80mmHg"
                    }
                },
                "protocols": {
                    "detox": {"pressure": "40mmHg", "duration": 35},
                    "immune": {"pressure": "60mmHg", "duration": 30},
                    "gentle": {"pressure": "20mmHg", "duration": 40}
                },
                "intensity_levels": {
                    "weak": {"pressure": 20, "description": "ì•½í•œ ê°•ë„"},
                    "medium": {"pressure": 40, "description": "ì¤‘ê°„ ê°•ë„"},
                    "strong": {"pressure": 60, "description": "ê°•í•œ ê°•ë„"}
                },
                "sort_order": 3
            },
            {
                "name": "ë ˆë“œ",
                "code": "RED",
                "description": "ì ì™¸ì„  ì¹˜ë£Œ - ì„¸í¬ ì¬ìƒ ë° ê·¼ìœ¡ íšŒë³µ ì´‰ì§„",
                "default_duration": 25,
                "default_price": 50000,
                "equipment_required": {
                    "red_light_device": {
                        "type": "led_therapy",
                        "model": "Red Light Therapy Panel",
                        "wavelength": "660nm, 850nm"
                    }
                },
                "protocols": {
                    "recovery": {"wavelength": "850nm", "duration": 25},
                    "skin": {"wavelength": "660nm", "duration": 20},
                    "deep_tissue": {"wavelength": "850nm", "duration": 30}
                },
                "intensity_levels": {
                    "weak": {"intensity": 30, "description": "ì•½í•œ ê°•ë„"},
                    "medium": {"intensity": 60, "description": "ì¤‘ê°„ ê°•ë„"},
                    "strong": {"intensity": 100, "description": "ê°•í•œ ê°•ë„"}
                },
                "sort_order": 4
            },
            {
                "name": "AIë°”ì´í¬",
                "code": "AI_BIKE",
                "description": "AI ê¸°ë°˜ ìš´ë™ í”„ë¡œê·¸ë¨ - ê°œì¸ ë§ì¶¤í˜• ìœ ì‚°ì†Œ ë° ê·¼ë ¥ ìš´ë™",
                "default_duration": 45,
                "default_price": 90000,
                "equipment_required": {
                    "ai_bike": {
                        "type": "smart_exercise_bike",
                        "model": "AI Fitness Bike Pro",
                        "features": ["heart_rate_monitor", "resistance_control", "motion_tracking"]
                    }
                },
                "protocols": {
                    "cardio": {"resistance": "medium", "duration": 45},
                    "strength": {"resistance": "high", "duration": 35},
                    "rehabilitation": {"resistance": "low", "duration": 50}
                },
                "intensity_levels": {
                    "weak": {"resistance": 3, "description": "ì•½í•œ ê°•ë„"},
                    "medium": {"resistance": 6, "description": "ì¤‘ê°„ ê°•ë„"},
                    "strong": {"resistance": 9, "description": "ê°•í•œ ê°•ë„"}
                },
                "sort_order": 5
            }
        ]
        
        for service_data in service_types:
            existing = db.query(EnhancedServiceType).filter(
                EnhancedServiceType.code == service_data["code"]
            ).first()
            
            if not existing:
                service_type = EnhancedServiceType(**service_data)
                db.add(service_type)
                print(f"  âœ… Created service type: {service_data['name']} ({service_data['code']})")
            else:
                print(f"  âš ï¸ Service type already exists: {service_data['name']}")
        
        db.commit()
        print("âœ… Default service types created successfully")
        
    except Exception as e:
        print(f"âŒ Error creating default service types: {e}")
        db.rollback()
        raise
    finally:
        db.close()

def create_default_equipment():
    """ê¸°ë³¸ ì¥ë¹„ ë°ì´í„° ìƒì„±"""
    db = next(get_db())
    try:
        equipment_list = [
            {
                "equipment_name": "ë¸Œë ˆì¸ ìµœì í™” ì¥ë¹„ #1",
                "equipment_code": "BRAIN_001",
                "equipment_type": "neurofeedback",
                "supported_services": {"services": ["BRAIN"], "primary": "BRAIN"}
            },
            {
                "equipment_name": "ë¸Œë ˆì¸ ìµœì í™” ì¥ë¹„ #2",
                "equipment_code": "BRAIN_002",
                "equipment_type": "neurofeedback",
                "supported_services": {"services": ["BRAIN"], "primary": "BRAIN"}
            },
            {
                "equipment_name": "í„ìŠ¤ ì¥ë¹„ #1",
                "equipment_code": "PULSE_001",
                "equipment_type": "electromagnetic",
                "supported_services": {"services": ["PULSE"], "primary": "PULSE"}
            },
            {
                "equipment_name": "í„ìŠ¤ ì¥ë¹„ #2",
                "equipment_code": "PULSE_002",
                "equipment_type": "electromagnetic",
                "supported_services": {"services": ["PULSE"], "primary": "PULSE"}
            },
            {
                "equipment_name": "í„ìŠ¤ ì¥ë¹„ #3",
                "equipment_code": "PULSE_003",
                "equipment_type": "electromagnetic",
                "supported_services": {"services": ["PULSE"], "primary": "PULSE"}
            },
            {
                "equipment_name": "ë¦¼í”„ ìˆœí™˜ ì¥ë¹„ #1",
                "equipment_code": "LYMPH_001",
                "equipment_type": "pressure_wave",
                "supported_services": {"services": ["LYMPH"], "primary": "LYMPH"}
            },
            {
                "equipment_name": "ë¦¼í”„ ìˆœí™˜ ì¥ë¹„ #2",
                "equipment_code": "LYMPH_002",
                "equipment_type": "pressure_wave",
                "supported_services": {"services": ["LYMPH"], "primary": "LYMPH"}
            },
            {
                "equipment_name": "ë ˆë“œ ë¼ì´íŠ¸ íŒ¨ë„ #1",
                "equipment_code": "RED_001",
                "equipment_type": "led_therapy",
                "supported_services": {"services": ["RED"], "primary": "RED"}
            },
            {
                "equipment_name": "ë ˆë“œ ë¼ì´íŠ¸ íŒ¨ë„ #2",
                "equipment_code": "RED_002",
                "equipment_type": "led_therapy",
                "supported_services": {"services": ["RED"], "primary": "RED"}
            },
            {
                "equipment_name": "ë ˆë“œ ë¼ì´íŠ¸ íŒ¨ë„ #3",
                "equipment_code": "RED_003",
                "equipment_type": "led_therapy",
                "supported_services": {"services": ["RED"], "primary": "RED"}
            },
            {
                "equipment_name": "AI ë°”ì´í¬ #1",
                "equipment_code": "AI_BIKE_001",
                "equipment_type": "smart_exercise_bike",
                "supported_services": {"services": ["AI_BIKE"], "primary": "AI_BIKE"}
            },
            {
                "equipment_name": "AI ë°”ì´í¬ #2",
                "equipment_code": "AI_BIKE_002",
                "equipment_type": "smart_exercise_bike",
                "supported_services": {"services": ["AI_BIKE"], "primary": "AI_BIKE"}
            }
        ]
        
        for equipment_data in equipment_list:
            existing = db.query(EquipmentManagement).filter(
                EquipmentManagement.equipment_code == equipment_data["equipment_code"]
            ).first()
            
            if not existing:
                equipment = EquipmentManagement(**equipment_data)
                db.add(equipment)
                print(f"  âœ… Created equipment: {equipment_data['equipment_name']}")
            else:
                print(f"  âš ï¸ Equipment already exists: {equipment_data['equipment_name']}")
        
        db.commit()
        print("âœ… Default equipment created successfully")
        
    except Exception as e:
        print(f"âŒ Error creating default equipment: {e}")
        db.rollback()
        raise
    finally:
        db.close()

def verify_schema():
    """ìŠ¤í‚¤ë§ˆ ìƒì„± í™•ì¸"""
    print("\n=== Schema Verification ===")
    
    with engine.connect() as conn:
        # ìƒˆë¡œ ìƒì„±ëœ í…Œì´ë¸” í™•ì¸
        tables_to_check = [
            'enhanced_service_types',
            'service_sessions',
            'enhanced_package_usage',
            'customer_service_preferences',
            'equipment_management'
        ]
        
        for table_name in tables_to_check:
            try:
                result = conn.execute(text(f"SELECT COUNT(*) FROM {table_name}"))
                count = result.scalar()
                print(f"âœ… Table '{table_name}': {count} records")
            except Exception as e:
                print(f"âŒ Table '{table_name}': {e}")

if __name__ == "__main__":
    try:
        create_enhanced_tables()
        verify_schema()
    except Exception as e:
        print(f"âŒ Fatal error: {e}")
        exit(1)