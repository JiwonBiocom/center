"""
Enhanced Service Sample Data Creation
í™•ì¥ëœ ì„œë¹„ìŠ¤ ê´€ë¦¬ ì‹œìŠ¤í…œ ìƒ˜í”Œ ë°ì´í„° ìƒì„±
"""

import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from datetime import date, time, datetime, timedelta
from decimal import Decimal
from core.database import get_db
from models.enhanced_service import (
    EnhancedServiceType,
    ServiceSession,
    EnhancedPackageUsage
)
from models.customer import Customer
from models.package import Package

def create_sample_enhanced_package_usages():
    """ìƒ˜í”Œ í™•ì¥ëœ íŒ¨í‚¤ì§€ ì‚¬ìš©ëŸ‰ ìƒì„±"""
    print("=== Creating Enhanced Package Usage Sample Data ===")
    
    db = next(get_db())
    try:
        # ê¸°ì¡´ ê³ ê° ë° íŒ¨í‚¤ì§€ í™•ì¸
        customers = db.query(Customer).limit(10).all()
        packages = db.query(Package).limit(5).all()
        
        if not customers or not packages:
            print("âŒ Need customers and packages first")
            return
        
        sample_usages = [
            {
                "customer_id": customers[0].customer_id,
                "package_id": packages[0].package_id,
                "purchase_date": date.today() - timedelta(days=30),
                "valid_until": date.today() + timedelta(days=335),  # 1ë…„ íŒ¨í‚¤ì§€
                "total_amount": Decimal("500000"),
                # ì¢…í•© íŒ¨í‚¤ì§€ (ê° ì„œë¹„ìŠ¤ 10íšŒì”©)
                "brain_total": 10,
                "pulse_total": 10,
                "lymph_total": 10,
                "red_total": 10,
                "ai_bike_total": 10,
                # ì‚¬ìš© í˜„í™© (ì¼ë¶€ ì‚¬ìš©ë¨)
                "brain_used": 3,
                "brain_remaining": 7,
                "pulse_used": 7,  # í„ìŠ¤ê°€ ê°€ì¥ ë§ì´ ì‚¬ìš©ë¨
                "pulse_remaining": 3,
                "lymph_used": 2,
                "lymph_remaining": 8,
                "red_used": 9,  # ë ˆë“œê°€ ê±°ì˜ ì†Œì§„
                "red_remaining": 1,
                "ai_bike_used": 1,
                "ai_bike_remaining": 9,
                "status": "active"
            },
            {
                "customer_id": customers[1].customer_id,
                "package_id": packages[1].package_id,
                "purchase_date": date.today() - timedelta(days=60),
                "valid_until": date.today() + timedelta(days=305),
                "total_amount": Decimal("300000"),
                # í„ìŠ¤ ì§‘ì¤‘ íŒ¨í‚¤ì§€
                "brain_total": 5,
                "pulse_total": 20,  # í„ìŠ¤ ì¤‘ì‹¬
                "lymph_total": 5,
                "red_total": 15,
                "ai_bike_total": 0,
                # ì‚¬ìš© í˜„í™©
                "brain_used": 4,
                "brain_remaining": 1,
                "pulse_used": 15,
                "pulse_remaining": 5,
                "lymph_used": 3,
                "lymph_remaining": 2,
                "red_used": 12,
                "red_remaining": 3,
                "ai_bike_used": 0,
                "ai_bike_remaining": 0,
                "status": "active"
            },
            {
                "customer_id": customers[2].customer_id,
                "package_id": packages[2].package_id,
                "purchase_date": date.today() - timedelta(days=15),
                "valid_until": date.today() + timedelta(days=350),
                "total_amount": Decimal("800000"),
                # í”„ë¦¬ë¯¸ì—„ íŒ¨í‚¤ì§€
                "brain_total": 15,
                "pulse_total": 15,
                "lymph_total": 15,
                "red_total": 15,
                "ai_bike_total": 15,
                # ê±°ì˜ ì‚¬ìš© ì•ˆí•¨ (ì‹ ê·œ)
                "brain_used": 1,
                "brain_remaining": 14,
                "pulse_used": 2,
                "pulse_remaining": 13,
                "lymph_used": 0,
                "lymph_remaining": 15,
                "red_used": 1,
                "red_remaining": 14,
                "ai_bike_used": 0,
                "ai_bike_remaining": 15,
                "status": "active"
            }
        ]
        
        for usage_data in sample_usages:
            existing = db.query(EnhancedPackageUsage).filter(
                EnhancedPackageUsage.customer_id == usage_data["customer_id"],
                EnhancedPackageUsage.package_id == usage_data["package_id"]
            ).first()
            
            if not existing:
                usage = EnhancedPackageUsage(**usage_data)
                db.add(usage)
                print(f"  âœ… Created package usage for customer {usage_data['customer_id']}")
            else:
                print(f"  âš ï¸ Package usage already exists for customer {usage_data['customer_id']}")
        
        db.commit()
        print("âœ… Enhanced package usage sample data created")
        
    except Exception as e:
        print(f"âŒ Error creating enhanced package usage: {e}")
        db.rollback()
        raise
    finally:
        db.close()

def create_sample_service_sessions():
    """ìƒ˜í”Œ ì„œë¹„ìŠ¤ ì„¸ì…˜ ìƒì„±"""
    print("\n=== Creating Service Session Sample Data ===")
    
    db = next(get_db())
    try:
        # í•„ìš”í•œ ë°ì´í„° í™•ì¸
        customers = db.query(Customer).limit(5).all()
        service_types = db.query(EnhancedServiceType).all()
        package_usages = db.query(EnhancedPackageUsage).all()
        
        if not customers or not service_types:
            print("âŒ Need customers and service types first")
            return
        
        # ì„œë¹„ìŠ¤ íƒ€ì… ID ë§¤í•‘
        service_type_map = {st.code: st.service_type_id for st in service_types}
        
        # ìµœê·¼ 7ì¼ê°„ì˜ ìƒ˜í”Œ ì„¸ì…˜ ìƒì„±
        sample_sessions = []
        
        for i in range(7):  # 7ì¼ê°„
            session_date = date.today() - timedelta(days=i)
            
            # í•˜ë£¨ì— 3-5ê°œ ì„¸ì…˜
            for j in range(3, 6):
                customer = customers[j % len(customers)]
                service_codes = ["PULSE", "BRAIN", "RED", "LYMPH", "AI_BIKE"]
                service_code = service_codes[j % len(service_codes)]
                
                session_time = time(9 + j * 2, 0)  # 9ì‹œ, 11ì‹œ, 13ì‹œ, 15ì‹œ, 17ì‹œ
                
                session_data = {
                    "customer_id": customer.customer_id,
                    "service_type_id": service_type_map[service_code],
                    "package_usage_id": package_usages[0].usage_id if package_usages else None,
                    "session_date": session_date,
                    "start_time": session_time,
                    "end_time": time(session_time.hour + 1, session_time.minute),
                    "duration_minutes": 60,
                    "equipment_settings": {
                        "equipment_code": f"{service_code}_001",
                        "intensity": "medium",
                        "protocol": "standard",
                        "temperature": 36.5 if service_code == "RED" else None,
                        "pressure": 40 if service_code == "LYMPH" else None
                    },
                    "protocol_used": "standard",
                    "intensity_level": "medium",
                    "session_notes": f"ì •ìƒì ì¸ {service_code} ì„¸ì…˜ ì§„í–‰",
                    "customer_condition": "ì–‘í˜¸",
                    "staff_notes": "ê³ ê° ë§Œì¡±ë„ ë†’ìŒ",
                    "is_completed": True,
                    "completion_rate": 100,
                    "conducted_by": 1  # ê´€ë¦¬ì ID
                }
                
                sample_sessions.append(session_data)
        
        # ì„¸ì…˜ ìƒì„±
        for session_data in sample_sessions:
            existing = db.query(ServiceSession).filter(
                ServiceSession.customer_id == session_data["customer_id"],
                ServiceSession.session_date == session_data["session_date"],
                ServiceSession.start_time == session_data["start_time"]
            ).first()
            
            if not existing:
                session = ServiceSession(**session_data)
                db.add(session)
        
        db.commit()
        
        # ìƒì„±ëœ ì„¸ì…˜ ìˆ˜ í™•ì¸
        total_sessions = db.query(ServiceSession).count()
        print(f"âœ… Service sessions created. Total sessions: {total_sessions}")
        
    except Exception as e:
        print(f"âŒ Error creating service sessions: {e}")
        db.rollback()
        raise
    finally:
        db.close()

def verify_sample_data():
    """ìƒ˜í”Œ ë°ì´í„° ìƒì„± í™•ì¸"""
    print("\n=== Sample Data Verification ===")
    
    db = next(get_db())
    try:
        # í…Œì´ë¸”ë³„ ë°ì´í„° ìˆ˜ í™•ì¸
        service_types_count = db.query(EnhancedServiceType).count()
        sessions_count = db.query(ServiceSession).count()
        package_usages_count = db.query(EnhancedPackageUsage).count()
        
        print(f"âœ… Enhanced Service Types: {service_types_count}")
        print(f"âœ… Service Sessions: {sessions_count}")
        print(f"âœ… Enhanced Package Usages: {package_usages_count}")
        
        # ìµœê·¼ ì„¸ì…˜ í™•ì¸
        recent_sessions = db.query(ServiceSession).order_by(
            ServiceSession.session_date.desc(),
            ServiceSession.start_time.desc()
        ).limit(5).all()
        
        print(f"\nRecent sessions:")
        for session in recent_sessions:
            print(f"  - Session {session.session_id}: {session.session_date} {session.start_time}")
        
        # íŒ¨í‚¤ì§€ ì‚¬ìš©ëŸ‰ í™•ì¸
        active_usages = db.query(EnhancedPackageUsage).filter(
            EnhancedPackageUsage.status == "active"
        ).all()
        
        print(f"\nActive package usages:")
        for usage in active_usages:
            print(f"  - Customer {usage.customer_id}: Pulse {usage.pulse_remaining}/{usage.pulse_total}")
        
    except Exception as e:
        print(f"âŒ Error verifying sample data: {e}")
    finally:
        db.close()

if __name__ == "__main__":
    try:
        create_sample_enhanced_package_usages()
        create_sample_service_sessions()
        verify_sample_data()
        print("\nğŸ‰ Enhanced service sample data creation completed!")
    except Exception as e:
        print(f"âŒ Fatal error: {e}")
        exit(1)